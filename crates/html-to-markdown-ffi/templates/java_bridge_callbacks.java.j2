// Code generated by generate_visitor_callbacks.py; DO NOT EDIT.
// Generator: scripts/generate_visitor_callbacks.py
// Schema: crates/html-to-markdown-ffi/visitor_callbacks.yaml
// Template: crates/html-to-markdown-ffi/templates/java_bridge_callbacks.java.j2

package sh.kreuzberg.htmltomarkdown.visitor;

import java.lang.foreign.*;
import java.lang.invoke.MethodHandle;

/**
 * Generated visitor callback bridge methods using Java 22+ Panama FFI.
 */
public class VisitorBridgeGenerated {
{% for callback in callbacks %}
{%- set java_method_name = callback.name | replace('_', ' ') | title | replace(' ', '') %}
{%- set java_method_name_lower = java_method_name[0].lower() + java_method_name[1:] %}

    /**
     * {{ callback.description }}
     * <p>
     * HTML elements: {{ callback.html_elements }}<br>
     * Frequency: {{ callback.frequency }}
     * </p>
     */
    public static MemorySegment create{{ java_method_name }}Callback(
        Arena arena,
        HtmlVisitor visitor
    ) {
        FunctionDescriptor descriptor = FunctionDescriptor.of(
            VisitResult.LAYOUT,
            ValueLayout.ADDRESS, // userData
            ValueLayout.ADDRESS  // ctx
            {%- for param in callback.parameters -%}
            {%- if param.name != 'ctx' -%}
            ,
            {%- if param.type == 'string' %}
            ValueLayout.ADDRESS  // {{ param.name }}
            {%- elif param.type == 'string_array' %}
            ValueLayout.ADDRESS, // {{ param.name }}
            ValueLayout.JAVA_LONG // {{ param.name }}Count
            {%- elif param.type == 'bool' %}
            ValueLayout.JAVA_BOOLEAN // {{ param.name }}
            {%- elif param.type == 'u32' %}
            ValueLayout.JAVA_INT // {{ param.name }}
            {%- elif param.type == 'usize' %}
            ValueLayout.JAVA_LONG // {{ param.name }}
            {%- endif %}
            {%- endif %}
            {%- endfor %}
        );

        MethodHandle handle;
        try {
            handle = MethodHandles.lookup().findStatic(
                VisitorBridgeGenerated.class,
                "{{ java_method_name_lower }}Callback",
                MethodType.methodType(
                    MemorySegment.class,
                    MemorySegment.class, // userData
                    MemorySegment.class  // ctx
                    {%- for param in callback.parameters -%}
                    {%- if param.name != 'ctx' -%}
                    ,
                    {%- if param.type == 'string' %}
                    MemorySegment.class  // {{ param.name }}
                    {%- elif param.type == 'string_array' %}
                    MemorySegment.class, // {{ param.name }}
                    long.class           // {{ param.name }}Count
                    {%- elif param.type == 'bool' %}
                    boolean.class        // {{ param.name }}
                    {%- elif param.type == 'u32' %}
                    int.class            // {{ param.name }}
                    {%- elif param.type == 'usize' %}
                    long.class           // {{ param.name }}
                    {%- endif %}
                    {%- endif %}
                    {%- endfor %}
                )
            );
        } catch (NoSuchMethodException | IllegalAccessException e) {
            throw new RuntimeException("Failed to create {{ java_method_name }} callback", e);
        }

        return Linker.nativeLinker().upcallStub(handle, descriptor, arena);
    }

    private static MemorySegment {{ java_method_name_lower }}Callback(
        MemorySegment userData,
        MemorySegment ctx
        {%- for param in callback.parameters -%}
        {%- if param.name != 'ctx' -%}
        ,
        {%- if param.type == 'string' %}
        MemorySegment {{ param.name }}Ptr
        {%- elif param.type == 'string_array' %}
        MemorySegment {{ param.name }}Ptr,
        long {{ param.name }}Count
        {%- elif param.type == 'bool' %}
        boolean {{ param.name }}
        {%- elif param.type == 'u32' %}
        int {{ param.name }}
        {%- elif param.type == 'usize' %}
        long {{ param.name }}
        {%- endif %}
        {%- endif %}
        {%- endfor %}
    ) {
        try {
            // Extract visitor from user data
            if (userData.address() == 0) {
                return VisitResult.continueResult();
            }

            HtmlVisitor visitor = (HtmlVisitor) userData.get(ValueLayout.ADDRESS, 0);
            if (visitor == null) {
                return VisitResult.continueResult();
            }

            // Marshal NodeContext
            NodeContext nodeContext = NodeContext.fromNative(ctx);

            {%- for param in callback.parameters %}
            {%- if param.name != 'ctx' %}
            {%- if param.type == 'string' %}
            {%- if param.nullable %}
            // Marshal nullable string
            String {{ param.name }} = {{ param.name }}Ptr.address() != 0
                ? {{ param.name }}Ptr.reinterpret(Long.MAX_VALUE).getUtf8String(0)
                : null;
            {%- else %}
            // Marshal non-null string
            String {{ param.name }} = {{ param.name }}Ptr.reinterpret(Long.MAX_VALUE).getUtf8String(0);
            {%- endif %}
            {%- elif param.type == 'string_array' %}
            // Marshal string array
            String[] {{ param.name }} = new String[(int) {{ param.name }}Count];
            if ({{ param.name }}Ptr.address() != 0) {
                MemorySegment arraySegment = {{ param.name }}Ptr.reinterpret({{ param.name }}Count * ValueLayout.ADDRESS.byteSize());
                for (int i = 0; i < {{ param.name }}Count; i++) {
                    MemorySegment strPtr = arraySegment.get(ValueLayout.ADDRESS, i * ValueLayout.ADDRESS.byteSize());
                    {{ param.name }}[i] = strPtr.reinterpret(Long.MAX_VALUE).getUtf8String(0);
                }
            }
            {%- endif %}
            {%- endif %}
            {%- endfor %}

            // Call visitor method
            VisitResult result = visitor.visit{{ java_method_name }}(
                nodeContext
                {%- for param in callback.parameters -%}
                {%- if param.name != 'ctx' -%}
                ,
                {{ param.name }}
                {%- endif %}
                {%- endfor %}
            );

            // Marshal result to native
            return result.toNative();
        } catch (Exception e) {
            return VisitResult.error("Exception in {{ java_method_name }}: " + e.getMessage());
        }
    }
{% endfor %}
}
