// Code generated by generate_visitor_callbacks.py; DO NOT EDIT.
// Generator: scripts/generate_visitor_callbacks.py
// Schema: crates/html-to-markdown-ffi/visitor_callbacks.yaml
// Template: crates/html-to-markdown-ffi/templates/csharp_bridge_callbacks.cs.j2

using System;
using System.Collections.Generic;
using System.Runtime.InteropServices;

namespace HtmlToMarkdown.Visitor;

/// <summary>
/// Generated visitor callback bridge methods.
/// This partial class contains the callback implementations that marshal between native and managed code.
/// </summary>
internal partial class VisitorBridge
{
{% for callback in callbacks %}
{# Special case name mappings to match NativeVisitorStructures.cs #}
{%- set name_map = {
    'iframe': 'IFrame',
    'figcaption': 'FigCaption'
} -%}
{%- set cs_method_name = name_map.get(callback.name, callback.name | replace('_', ' ') | title | replace(' ', '')) %}
    /// <summary>
    /// {{ callback.description }}
    /// </summary>
    /// <remarks>
    /// HTML elements: {{ callback.html_elements }}<br/>
    /// Frequency: {{ callback.frequency }}
    /// </remarks>
    private NativeVisitorStructures.NativeVisitResult Visit{{ cs_method_name }}Callback(
        IntPtr userData,
        IntPtr ctx
        {%- for param in callback.parameters -%}
        {%- if param.name != 'ctx' -%}
        ,
        {%- if param.type == 'string' %}
        IntPtr {{ param.name }}
        {%- elif param.type == 'string_array' %}
        IntPtr {{ param.name }},
        nuint {{ param.name }}Count
        {%- elif param.type == 'bool' %}
        bool {{ param.name }}
        {%- elif param.type == 'u32' %}
        uint {{ param.name }}
        {%- elif param.type == 'usize' %}
        nuint {{ param.name }}
        {%- endif %}
        {%- endif %}
        {%- endfor %})
    {
        try
        {
            var context = UnmarshalNodeContext(ctx);
            {%- for param in callback.parameters %}
            {%- if param.name != 'ctx' %}
            {%- if param.type == 'string' %}
            {%- if param.nullable %}
            var {{ param.name }}Str = {{ param.name }} != IntPtr.Zero ? PtrToStringUtf8({{ param.name }}) : null;
            {%- else %}
            var {{ param.name }}Str = PtrToStringUtf8({{ param.name }}) ?? "";
            {%- endif %}
            {%- elif param.type == 'string_array' %}
            var {{ param.name }}List = new List<string>();
            if ({{ param.name }} != IntPtr.Zero)
            {
                for (nuint i = 0; i < {{ param.name }}Count; i++)
                {
                    var cellPtrPtr = IntPtr.Add({{ param.name }}, (int)i * IntPtr.Size);
                    var cellPtr = Marshal.ReadIntPtr(cellPtrPtr);
                    var cellStr = PtrToStringUtf8(cellPtr) ?? "";
                    {{ param.name }}List.Add(cellStr);
                }
            }
            {%- endif %}
            {%- endif %}
            {%- endfor %}
            var result = _visitor.Visit{{ cs_method_name }}(
                context
                {%- for param in callback.parameters -%}
                {%- if param.name != 'ctx' -%}
                ,
                {%- if param.type == 'string' %}
                {{ param.name }}Str
                {%- elif param.type == 'string_array' %}
                {{ param.name }}List.AsReadOnly()
                {%- elif param.type == 'bool' %}
                {{ param.name }}
                {%- elif param.type == 'u32' %}
                (int){{ param.name }}
                {%- elif param.type == 'usize' %}
                (int){{ param.name }}
                {%- endif %}
                {%- endif %}
                {%- endfor %});
            return MarshalVisitResult(result);
        }
        catch (Exception ex)
        {
            return MarshalVisitResult(VisitResult.Error($"Visit{{ cs_method_name }} error: {ex.Message}"));
        }
    }

{% endfor %}
}
