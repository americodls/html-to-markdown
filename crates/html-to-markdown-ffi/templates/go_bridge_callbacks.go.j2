//go:build disabled

// Code generated by generate_visitor_callbacks.py; DO NOT EDIT.
// Generator: scripts/generate_visitor_callbacks.py
// Schema: crates/html-to-markdown-ffi/visitor_callbacks.yaml
// Template: crates/html-to-markdown-ffi/templates/go_bridge_callbacks.go.j2
//
// NOTE: This file is currently disabled via build tag because the generated
// visitor API uses different method names and struct fields than the existing
// visitor.go implementation. This is work-in-progress code that will be enabled
// once the visitor pattern is refactored for consistency.

package htmltomarkdown

/*
#include <stdlib.h>
#include <stdbool.h>
#include <stdint.h>
#include <string.h>

#ifndef HTML_TO_MARKDOWN_TYPES_H
#define HTML_TO_MARKDOWN_TYPES_H

// Result type enumeration (matching FFI HtmlToMarkdownVisitResultType)
typedef enum {
    HTML_TO_MARKDOWN_VISIT_CONTINUE = 0,
    HTML_TO_MARKDOWN_VISIT_CUSTOM = 1,
    HTML_TO_MARKDOWN_VISIT_SKIP = 2,
    HTML_TO_MARKDOWN_VISIT_PRESERVE_HTML = 3,
    HTML_TO_MARKDOWN_VISIT_ERROR = 4
} HtmlToMarkdownVisitResultType;

// Forward declarations for C types
typedef struct {
    uint32_t node_type;
    const char* tag_name;
    const char* parent_tag;
    size_t depth;
    size_t index_in_parent;
    bool is_inline;
    bool is_first_child;
    bool is_last_child;
    bool has_siblings;
} html_to_markdown_node_context_t;

typedef struct {
    uint32_t result_type;
    char* custom_output;
    char* error_message;
} html_to_markdown_visit_result_t;

#endif // HTML_TO_MARKDOWN_TYPES_H
*/
import "C"
import (
	"unsafe"
)

{% for callback in callbacks %}
{%- set go_method_name = callback.name | replace('_', ' ') | title | replace(' ', '') %}
// {{ go_method_name }}Callback wraps the user's Go callback for {{ callback.name }}.
//
// {{ callback.description }}
// HTML elements: {{ callback.html_elements }}
//
//export go{{ go_method_name }}Callback
func go{{ go_method_name }}Callback(
	userData unsafe.Pointer,
	ctx *C.html_to_markdown_node_context_t,
	{%- for param in callback.parameters %}
	{%- if param.name != 'ctx' %}
	{%- if param.type == 'string' %}
	{%- if param.nullable %}
	c{{ param.name | title | replace('_', '') }} *C.char,
	{%- else %}
	c{{ param.name | title | replace('_', '') }} *C.char,
	{%- endif %}
	{%- elif param.type == 'string_array' %}
	c{{ param.name | title | replace('_', '') }} **C.char,
	c{{ param.name | title | replace('_', '') }}Count C.size_t,
	{%- elif param.type == 'bool' %}
	c{{ param.name | title | replace('_', '') }} C.bool,
	{%- elif param.type == 'u32' %}
	c{{ param.name | title | replace('_', '') }} C.uint,
	{%- elif param.type == 'usize' %}
	c{{ param.name | title | replace('_', '') }} C.size_t,
	{%- endif %}
	{%- endif %}
	{%- endfor %}
) C.html_to_markdown_visit_result_t {
	// Extract the visitor from user data
	if userData == nil {
		return continueResult()
	}

	visitor := (*Visitor)(userData)
	if visitor.{{ go_method_name }} == nil {
		return continueResult()
	}

	// Convert C types to Go types
	goCtx := &NodeContext{
		NodeType:   NodeType(ctx.node_type),
		TagName:    C.GoString(ctx.tag_name),
		Depth:      int(ctx.depth),
		IsFirstChild: bool(ctx.is_first_child),
		IsLastChild:  bool(ctx.is_last_child),
		HasSiblings:  bool(ctx.has_siblings),
	}
{%- for param in callback.parameters %}
{%- if param.name != 'ctx' %}
{%- if param.type == 'string' %}
{%- if param.nullable %}

	var go{{ param.name | title | replace('_', '') }} *string
	if c{{ param.name | title | replace('_', '') }} != nil {
		s := C.GoString(c{{ param.name | title | replace('_', '') }})
		go{{ param.name | title | replace('_', '') }} = &s
	}
{%- else %}

	go{{ param.name | title | replace('_', '') }} := C.GoString(c{{ param.name | title | replace('_', '') }})
{%- endif %}
{%- elif param.type == 'string_array' %}

	go{{ param.name | title | replace('_', '') }} := make([]string, int(c{{ param.name | title | replace('_', '') }}Count))
	{
		cArray := (*[1 << 30]*C.char)(unsafe.Pointer(c{{ param.name | title | replace('_', '') }}))
		for i := 0; i < int(c{{ param.name | title | replace('_', '') }}Count); i++ {
			go{{ param.name | title | replace('_', '') }}[i] = C.GoString(cArray[i])
		}
	}
{%- elif param.type == 'bool' %}

	go{{ param.name | title | replace('_', '') }} := bool(c{{ param.name | title | replace('_', '') }})
{%- elif param.type == 'u32' %}

	go{{ param.name | title | replace('_', '') }} := uint32(c{{ param.name | title | replace('_', '') }})
{%- elif param.type == 'usize' %}

	go{{ param.name | title | replace('_', '') }} := uint(c{{ param.name | title | replace('_', '') }})
{%- endif %}
{%- endif %}
{%- endfor %}

	// Call the user's Go callback
	result := visitor.{{ go_method_name }}(
		goCtx,
		{%- for param in callback.parameters %}
		{%- if param.name != 'ctx' %}
		go{{ param.name | title | replace('_', '') }},
		{%- endif %}
		{%- endfor %}
	)

	// Convert Go VisitResult to C result
	return visitResultToC(result)
}

{% endfor %}

// continueResult returns a Continue result.
func continueResult() C.html_to_markdown_visit_result_t {
	return C.html_to_markdown_visit_result_t{
		result_type:   C.HTML_TO_MARKDOWN_VISIT_CONTINUE,
		custom_output: nil,
		error_message: nil,
	}
}

// visitResultToC converts a Go VisitResult to C representation.
func visitResultToC(result VisitResult) C.html_to_markdown_visit_result_t {
	switch result.Type {
	case VisitContinue:
		return C.html_to_markdown_visit_result_t{
			result_type:   C.HTML_TO_MARKDOWN_VISIT_CONTINUE,
			custom_output: nil,
			error_message: nil,
		}
	case VisitCustom:
		return C.html_to_markdown_visit_result_t{
			result_type:   C.HTML_TO_MARKDOWN_VISIT_CUSTOM,
			custom_output: C.CString(result.CustomOutput),
			error_message: nil,
		}
	case VisitSkip:
		return C.html_to_markdown_visit_result_t{
			result_type:   C.HTML_TO_MARKDOWN_VISIT_SKIP,
			custom_output: nil,
			error_message: nil,
		}
	case VisitPreserveHtml:
		return C.html_to_markdown_visit_result_t{
			result_type:   C.HTML_TO_MARKDOWN_VISIT_PRESERVE_HTML,
			custom_output: nil,
			error_message: nil,
		}
	case VisitError:
		return C.html_to_markdown_visit_result_t{
			result_type:   C.HTML_TO_MARKDOWN_VISIT_ERROR,
			custom_output: nil,
			error_message: C.CString(result.ErrorMessage),
		}
	default:
		return continueResult()
	}
}
